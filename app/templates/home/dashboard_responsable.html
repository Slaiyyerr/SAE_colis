{% extends 'layout.html' %}

{% block title %}Gestion des colis - Tableau de bord{% endblock %}

{% block content %}
<div class="container">
    <h1 class="titre">Tableau de bord - Responsable colis</h1>
    <p class="sous-titre">Gestion des réceptions et distributions</p>

    <!-- Statistiques colis -->
    <div class="grille-stats">
        <div class="stat-card">
            <div class="number">{{ stats.total_colis }}</div>
            <div class="label">Total colis</div>
        </div>
        <div class="stat-card">
            <div class="number waiting">{{ stats.colis_attendus }}</div>
            <div class="label">À réceptionner</div>
        </div>
        <div class="stat-card">
            <div class="number waiting">{{ stats.colis_recus }}</div>
            <div class="label">À distribuer</div>
        </div>
        <div class="stat-card">
            <div class="number distribuer">{{ stats.colis_en_distribution }}</div>
            <div class="label">En distribution</div>
        </div>
        <div class="stat-card">
            <div class="number probleme">{{ stats.colis_probleme }}</div>
            <div class="label">Incidents</div>
        </div>
    </div>

    <div class="grille-stats">
        <!-- Colis a receptionner -->
        <div class="carte">
            <h2 class="petit-titre">Colis à réceptionner</h2>
            {% if stats.colis_a_receptionner %}
            <div class="tableau-container">
                <table class="tableau">
                    <thead>
                        <tr>
                            <th>N° Suivi</th>
                            <th>Transporteur</th>
                            <th>Destination</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in stats.colis_a_receptionner %}
                        <tr>
                            <td><strong>{{ c.num_suivi_transporteur or 'N/A' }}</strong></td>
                            <td>{{ c.nom_transporteur or '-' }}</td>
                            <td>{{ c.departement_nom or 'Non identifie' }}</td>
                            <td><a href="{{ url_for('colis_detail', id=c.id_colis) }}" class="bouton bouton-actions">Traiter</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="message-vide">Aucun colis en attente de réception.</p>
            {% endif %}
            <a href="{{ url_for('colis_en_attente') }}" class="lien">Voir tous les colis en attente</a>
        </div>

        <!-- Colis a distribuer -->
        <div class="carte">
            <h2 class="petit-titre">Colis reçus à distribuer</h2>
            {% if stats.colis_a_distribuer %}
            <div class="tableau-container">
                <table class="tableau">
                    <thead>
                        <tr>
                            <th>N Suivi</th>
                            <th>Destination</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in stats.colis_a_distribuer %}
                        <tr>
                            <td><strong>{{ c.num_suivi_transporteur or 'N/A' }}</strong></td>
                            <td>{{ c.departement_nom or 'Non identifie' }}</td>
                            <td>
                                {% if c.statut_actuel == 'recu' %}
                                <span class="principal">Recu</span>
                                {% elif c.statut_actuel == 'en_distribution' %}
                                <span class="distribuer">En distribution</span>
                                {% endif %}
                            </td>
                            <td><a href="{{ url_for('colis_detail', id=c.id_colis) }}" class="bouton bouton-actions">Traiter</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="message-vide">Aucun colis à distribuer.</p>
            {% endif %}
            <a href="{{ url_for('colis_a_distribuer') }}" class="lien">Voir tous les colis à distribuer</a>
        </div>
    </div>

    <!-- Incidents en cours -->
    {% if stats.colis_incidents %}
    <div class="carte">
        <h2 class="petit-titre">Incidents en cours</h2>
        <div class="tableau-container">
            <table class="tableau">
                <thead>
                    <tr>
                        <th>N° Suivi</th>
                        <th>Transporteur</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in stats.colis_incidents %}
                    <tr>
                        <td><strong class="probleme">{{ c.num_suivi_transporteur or 'N/A' }}</strong></td>
                        <td>{{ c.nom_transporteur or '-' }}</td>
                        <td>{{ c.notes or '-' }}</td>
                        <td><a href="{{ url_for('colis_detail', id=c.id_colis) }}" class="bouton danger bouton-actions">Gérer</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <a href="{{ url_for('colis_incidents') }}" class="lien">Voir tous les incidents</a>
    </div>
    {% endif %}

    <!-- Actions rapides -->
    <div class="carte" id="actions_rapide">
        <h2 class="petit-titre">Actions rapides</h2>
        <div class="flex">
            <a href="{{ url_for('colis_scan') }}" class="bouton bouton-ok">Scanner un colis</a>
            <a href="{{ url_for('colis_list') }}" class="bouton">Tous les colis</a>
            <a href="{{ url_for('colis_search') }}" class="bouton">Rechercher</a>
            <a href="{{ url_for('colis_incidents') }}" class="bouton {% if stats.colis_probleme > 0 %}danger{% endif %}">Incidents ({{ stats.colis_probleme }})</a>
            <a href="{{ url_for('commandes_list') }}" class="bouton">Voir les commandes</a>
        </div>
    </div>

    <!-- Activite recente -->
    <div class="carte" id="activite_recente">
        <h2 class="petit-titre">Activité récente</h2>
        {% if stats.activite_recente %}
        <div class="tableau-container">
            <table class="tableau">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Action</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in stats.activite_recente %}
                    <tr>
                        <td>{{ h.date_heure.strftime('%d/%m %H:%M') if h.date_heure else '-' }}</td>
                        <td>{{ h.action }}</td>
                        <td>{{ h.ancien_statut or '' }} -> {{ h.nouveau_statut or '' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="message-vide">Aucune activité récente.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
